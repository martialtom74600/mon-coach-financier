// =========================================================
// 1. CONFIGURATION
// =========================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("POSTGRES_PRISMA_URL") // Connection pooling
  directUrl = env("POSTGRES_URL") // Direct connection (Migrations)
}

// =========================================================
// 2. ENUMS
// =========================================================

enum UserPersona {
  SALARIED
  FREELANCE
  STUDENT
  RETIRED
}

enum HousingStatus {
  TENANT
  OWNER_LOAN
  OWNER_PAID
  FREE
}

// ✅ OPTIMISATION : Enum pour la fréquence (évite les fautes de frappe "mensuel" vs "monthly")
enum Frequency {
  DAILY
  WEEKLY
  MONTHLY
  QUARTERLY // Trimestriel
  YEARLY // Annuel
  ONCE // Ponctuel
}

enum ItemCategory {
  INCOME
  FIXED_COST
  SUBSCRIPTION
  CREDIT
  ANNUAL_EXPENSE
  VARIABLE_COST
}

enum AssetType {
  CC
  LIVRET
  PEA
  CTO
  AV
  PER
  PEE
  CRYPTO
  REAL_ESTATE
  GOLD
  CROWD
  OTHER
}

enum GoalCategory {
  REAL_ESTATE
  VEHICLE
  TRAVEL
  WEDDING
  EMERGENCY
  RETIREMENT
  PROJECT
  OTHER
}

enum PurchaseType {
  NEED
  PLEASURE
  OPPORTUNITY
  PROBLEM
}

enum PaymentMode {
  CASH_SAVINGS
  CASH_CURRENT
  CREDIT
  SPLIT
}

// =========================================================
// 3. TABLES (MODÈLES)
// =========================================================

model User {
  id        String   @id // ID Clerk
  email     String   @unique
  firstName String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  profile FinancialProfile?
}

model FinancialProfile {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // --- IDENTITÉ & SITUATION ---
  age           Int?
  persona       UserPersona?
  housingStatus HousingStatus?

  // NOTE : Si housingCost est rempli ici, attention à ne pas le doublonner dans FinancialItem
  housingCost Float @default(0)

  housingPaymentDay Int? @default(5)

  adults   Int @default(1)
  children Int @default(0)

  // --- STRATÉGIE ---
  funBudget Float @default(0)

  // --- RELATIONS ---
  items     FinancialItem[]
  assets    Asset[]
  goals     FinancialGoal[]
  decisions PurchaseDecision[]

  updatedAt DateTime @updatedAt
}

model FinancialItem {
  id        String           @id @default(cuid())
  profileId String
  profile   FinancialProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  name     String
  amount   Float        @default(0)
  category ItemCategory

  // ✅ OPTIMISATION : Utilisation de l'Enum Frequency
  frequency Frequency @default(MONTHLY)

  // Jour du prélèvement (ex: 1 pour le 1er du mois). 
  // Astuce : Mettre 32 pour "Fin de mois" dans ton code métier
  dayOfMonth Int? @default(1)

  createdAt DateTime @default(now())
}

model Asset {
  id        String           @id @default(cuid())
  profileId String
  profile   FinancialProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  name String
  type AssetType

  currentValue Float @default(0)
  monthlyFlow  Float @default(0)
  transferDay  Int   @default(1)

  // ✅ OPTIMISATION : Relation vers l'historique pour tracer les courbes
  history AssetHistory[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt // Utile pour savoir quand le montant a été rafraîchi
}

// ✅ NOUVEAU : Historique de valeur pour les graphiques
model AssetHistory {
  id      String @id @default(cuid())
  assetId String
  asset   Asset  @relation(fields: [assetId], references: [id], onDelete: Cascade)

  value Float // La valeur à l'instant T
  date  DateTime @default(now()) // Date de l'enregistrement (snapshot)

  @@index([assetId, date]) // Index pour rendre les requêtes graphiques rapides
}

model FinancialGoal {
  id        String           @id @default(cuid())
  profileId String
  profile   FinancialProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  name     String
  category GoalCategory @default(OTHER)

  targetAmount        Float
  currentSaved        Float @default(0)
  monthlyContribution Float @default(0)

  deadline DateTime

  projectedYield Float @default(0)
  transferDay    Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PurchaseDecision {
  id        String           @id @default(cuid())
  profileId String
  profile   FinancialProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  name        String
  amount      Float
  date        DateTime
  type        PurchaseType
  paymentMode PaymentMode

  // --- CONTEXTE ---
  isPro Boolean @default(false)

  // ✅ OPTIMISATION : Gestion plus fine du remboursement
  isReimbursable Boolean   @default(false)
  reimbursedAt   DateTime? // Si null -> Pas encore remboursé. Si date -> Remboursé le...

  // --- CRÉDIT / SPLIT ---
  duration Int? // Mois
  rate     Float? // Taux

  createdAt DateTime @default(now())
}
