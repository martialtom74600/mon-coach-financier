// =========================================================
// 1. CONFIGURATION
// =========================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("POSTGRES_PRISMA_URL") // Connection pooling
  directUrl = env("POSTGRES_URL")        // Direct connection (Migrations)
}

// =========================================================
// 2. ENUMS (Listes de choix fixes)
// =========================================================

enum UserPersona {
  SALARIED
  FREELANCE
  STUDENT
  RETIRED
  UNEMPLOYED // Ajouté au cas où
}

enum HousingStatus {
  TENANT
  OWNER_LOAN
  OWNER_PAID
  FREE
}

enum Frequency {
  DAILY
  WEEKLY
  MONTHLY
  QUARTERLY
  YEARLY
  ONCE
}

enum ItemCategory {
  INCOME
  FIXED_COST
  SUBSCRIPTION
  CREDIT
  ANNUAL_EXPENSE
  VARIABLE_COST
}

// ✅ AMÉLIORATION : Liste exhaustive pour éviter les erreurs de mapping
enum AssetType {
  CC          // Compte Courant
  LIVRET      // Livret A, standard
  LDDS        // Livret Développement Durable
  LEP         // Livret Épargne Populaire (Celui qui posait problème)
  PEL         // Plan Épargne Logement
  CEL         // Compte Épargne Logement
  PEA         // Plan Épargne Actions
  CTO         // Compte Titres Ordinaire
  AV          // Assurance Vie
  PER         // Plan Épargne Retraite
  PEE         // Plan Épargne Entreprise
  CRYPTO      // Actifs numériques
  REAL_ESTATE // Immobilier Physique
  SCPI        // Immobilier Papier (Pierre-papier)
  GOLD        // Matières premières
  CROWD       // Crowdfunding / Lending
  OTHER       // Montres, Art, Vin...
}

enum GoalCategory {
  REAL_ESTATE
  VEHICLE
  TRAVEL
  WEDDING
  EMERGENCY
  RETIREMENT
  PROJECT
  OTHER
}

enum PurchaseType {
  NEED
  PLEASURE
  OPPORTUNITY
  PROBLEM
}

enum PaymentMode {
  CASH_SAVINGS
  CASH_CURRENT
  CREDIT
  SPLIT
}

// =========================================================
// 3. TABLES (MODÈLES)
// =========================================================

model User {
  id        String   @id // ID Clerk (ex: user_2bX...)
  email     String   @unique
  firstName String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  profile   FinancialProfile?

  @@map("users") // Nom de la table en BDD : 'users'
}

model FinancialProfile {
  id        String   @id @default(cuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // --- IDENTITÉ & SITUATION ---
  age               Int?
  persona           UserPersona?
  housingStatus     HousingStatus?
  
  // Coût du logement (Sert de cache/référence rapide)
  housingCost       Float         @default(0) 
  housingPaymentDay Int?          @default(5) 

  adults            Int           @default(1)
  children          Int           @default(0)

  // --- STRATÉGIE ---
  funBudget         Float         @default(0)

  // --- RELATIONS ---
  items     FinancialItem[]
  assets    Asset[]
  goals     FinancialGoal[]
  decisions PurchaseDecision[]

  updatedAt DateTime @updatedAt

  @@map("financial_profiles")
}

model FinancialItem {
  id        String   @id @default(cuid())
  profileId String
  profile   FinancialProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  name      String
  amount    Float        @default(0)
  category  ItemCategory
  frequency Frequency    @default(MONTHLY)
  
  // Jour du prélèvement (ex: 1). Null si variable.
  dayOfMonth Int?        @default(1) 

  createdAt DateTime @default(now())

  // ✅ OPTIMISATION : Index pour récupérer vite les items d'un profil
  @@index([profileId])
  @@map("financial_items")
}

model Asset {
  id        String   @id @default(cuid())
  profileId String
  profile   FinancialProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  name         String
  type         AssetType // Utilise la liste étendue (LEP, PEL, etc.)
  
  currentValue Float @default(0) 
  monthlyFlow  Float @default(0) 
  transferDay  Int   @default(1) 

  history      AssetHistory[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt 

  @@index([profileId])
  @@map("assets")
}

model AssetHistory {
  id        String   @id @default(cuid())
  assetId   String
  asset     Asset    @relation(fields: [assetId], references: [id], onDelete: Cascade)
  
  value     Float    // Valeur enregistrée
  date      DateTime @default(now()) 

  // ✅ OPTIMISATION : Index composite pour tracer les courbes rapidement
  @@index([assetId, date])
  @@map("asset_history")
}

model FinancialGoal {
  id        String   @id @default(cuid())
  profileId String
  profile   FinancialProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  name      String
  category  GoalCategory @default(OTHER)
  
  targetAmount        Float
  currentSaved        Float    @default(0)
  monthlyContribution Float    @default(0)
  
  deadline            DateTime
  
  projectedYield      Float    @default(0)
  transferDay         Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([profileId])
  @@map("financial_goals")
}

model PurchaseDecision {
  id        String   @id @default(cuid())
  profileId String
  profile   FinancialProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  name        String
  amount      Float
  date        DateTime
  type        PurchaseType
  paymentMode PaymentMode

  // --- CONTEXTE ---
  isPro          Boolean @default(false)
  isReimbursable Boolean @default(false)
  reimbursedAt   DateTime? 

  // --- CRÉDIT / SPLIT ---
  duration       Int?    // Mois
  rate           Float?  // Taux

  createdAt      DateTime @default(now())

  @@index([profileId])
  @@map("purchase_decisions")
}